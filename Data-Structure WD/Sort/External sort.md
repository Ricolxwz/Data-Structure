 ## 外部排序

 ### 外存、内存之间的数据交换

 - 操作系统以“块”为单位对磁盘存储空间进行管理
 - 磁盘的读/写以“块”为单位, 数据读入内存后才能被修改, 修改完了还要写回磁盘

### 过程

1. 根据内存缓冲区大小, 将外存上的文件分成若干长度为l的子文件, 依次读入内存并利用内部排序的方法对他们进行排序, 并将排序后得到的有序子文件重新写回外存, 称这些有序子文件为归并段或顺串
2. 对这些归并段进行逐趟归并, 使归并段(有序子文件)逐渐从小到大, 直至得到整个有序文件

### 逐趟归并原理

![2路归并](https://github.com/Ricolxwz/Data-Structure/blob/main/IMG/Graph/External%20sort1.png)

把内存工作区等分为3个缓冲区, 其中两个为输入缓冲区, 一个为输出缓冲区
1. 首先, 从两个归并段R1和R2中分别读入一个块, 放在输入缓冲区1和输入缓冲区2中
2. 然后, 在内存中进行2路归并, 归并后的对象顺序存放在输出缓冲区中. 若输出缓冲区中的对象存满, 则将其顺序写到输出归并段(R1')中, 再清空输出缓冲区, 继续存放归并后的对象. 若某个输入缓冲区中的对象取空, 则从对应的输入归并段中再取下一块, 继续参加归并. 如此继续, 知道两个输入归并段中的对象全部读入内存并都完成归并为止.
3. 最终将所有的归并段合并, 得到最终的有序文件

### 时间开销分析

过程: 生成初始归并段->第一次归并->第二次归并...->第n次归并

![时间开销分析](https://github.com/Ricolxwz/Data-Structure/blob/main/IMG/Graph/External%20sort2.png)

- 外部排序时间开销 = 读写外存的时间 + 内部排序的时间 + 内部归并所需的时间
- 上图中, 读写磁盘的次数=32+32*3=128次, 若每次读写需要10ms, 则读写外存的时间开销是1280ms, 1.28s. 内存排序所需的时间和内部归并所需的时间相对于读写外存时间可以忽略

### 优化: 多路归并

- 采用多路归并可以减少归并的次数, 从而减少磁盘I/O(读写)次数. 如利用4路归并, 可以实现“4合1”的操作. 
- 对于r个初始归并段, 做k路归并, 则归并树可用k叉树表示; 若树高为h, 则归并趟数=h-1=⌈logkr⌉. 推导: k叉树第h层最多有k^(h-1)个结点, 则r≤k^(h-1), (h-1)min=⌈logkr⌉. 根据公式可以推出, k越大, r越小, 归并躺数越小, 读写磁盘次数越少

#### 负面影响

- k路合并时, 需要开辟k个输入缓冲区, 内存的开销增加
- 每挑选一个关键字需要对比关键字(k-1)次, 内部归并所需的时间增加

#### 优化: 减少初始归并段的数量

- 生成初始归并段的“内存工作区”越大, 初始归并段越长
- 结论: 若能增加初始归并段的长度, 则可减少初始归并段的数量r